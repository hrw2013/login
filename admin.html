<!doctype html>
<html lang="en">
<head>
<meta charset="utf-8" />
<meta name="viewport" content="width=device-width,initial-scale=1" />
<title>Admin Dashboard</title>
<link rel="stylesheet" href="style.css">
<style>
body.admin-page {
  background: linear-gradient(135deg, #111827, #0f766e);
  color: #fff;
  font-family: system-ui;
  padding: 20px;
}
table {
  width: 100%;
  border-collapse: collapse;
  margin-top: 20px;
}
th, td {
  border: 1px solid #475569;
  padding: 10px;
}
th {
  background: #0d9488;
  color: #000;
}
td {
  background: #134e4a;
}
button {
  background: #14b8a6;
  color: #000;
  border: none;
  padding: 6px 10px;
  border-radius: 6px;
  cursor: pointer;
  margin: 2px;
}
input {
  background: #0f766e;
  color: white;
  border: none;
  border-radius: 4px;
  padding: 4px;
  width: 90%;
}
.message-all {
  margin-top: 10px;
}
</style>
</head>
<body class="admin-page">
<h2>Admin Dashboard</h2>
<p id="admin-email"></p>

<!-- Message All Section -->
<div class="message-all">
  <input id="msg-all" placeholder="Enter message for all users" style="width:70%;">
  <button id="msg-all-btn">Message All</button>
</div>

<table id="user-table">
  <thead>
    <tr>
      <th>Name</th>
      <th>Email</th>
      <th>Message</th>
      <th>Action</th>
    </tr>
  </thead>
  <tbody></tbody>
</table>

<button id="logout">Logout</button>

<script type="module">
import { initializeApp } from "https://www.gstatic.com/firebasejs/11.0.0/firebase-app.js";
import { getAuth, onAuthStateChanged, signOut } from "https://www.gstatic.com/firebasejs/11.0.0/firebase-auth.js";
import { getFirestore, collection, doc, setDoc, deleteDoc, onSnapshot } from "https://www.gstatic.com/firebasejs/11.0.0/firebase-firestore.js";

// Firebase config
const firebaseConfig = {
  apiKey: "AIzaSyA10rt9j5WUTp8-T0i7qcpWp1uIu3oI_Wc",
  authDomain: "login-dashboard-4aa87.firebaseapp.com",
  projectId: "login-dashboard-4aa87",
  storageBucket: "login-dashboard-4aa87.firebasestorage.app",
  messagingSenderId: "196276515757",
  appId: "1:196276515757:web:c8420101386483f40de724",
  measurementId: "G-LBEHKCTYLF"
};

// Initialize Firebase
const app = initializeApp(firebaseConfig);
const auth = getAuth(app);
const db = getFirestore(app);
const ADMIN_EMAIL = "harrisonrobertwoods@gmail.com";

// Check admin login
onAuthStateChanged(auth, async user => {
  if (!user || user.email !== ADMIN_EMAIL) {
    alert('Access denied. Redirecting to login.');
    location.href = 'index.html';
    return;
  }
  document.getElementById('admin-email').innerText = "Logged in as " + user.email;
  loadUsersRealtime();
});

// Load users in real-time
function loadUsersRealtime() {
  const tbody = document.querySelector('#user-table tbody');
  const usersCol = collection(db, "users");

  onSnapshot(usersCol, snapshot => {
    tbody.innerHTML = '';
    if (snapshot.empty) {
      const tr = document.createElement('tr');
      tr.innerHTML = `<td colspan="4" style="text-align:center;">No users found</td>`;
      tbody.appendChild(tr);
      return;
    }

    snapshot.forEach(u => {
      const data = u.data();
      const tr = document.createElement('tr');
      tr.innerHTML = `
        <td>${data.name}</td>
        <td>${data.email}</td>
        <td><input id="msg-${u.id}" placeholder="Enter message"></td>
        <td>
          <button onclick="sendMsg('${u.id}')">Send</button>
          <button onclick="delUser('${u.id}')">Delete</button>
        </td>`;
      tbody.appendChild(tr);
    });
  });
}

// Send message to user
window.sendMsg = async uid => {
  const text = document.getElementById('msg-' + uid).value;
  if (!text.trim()) return alert('Enter a message first.');
  await setDoc(doc(db, "messages", uid), { text });
  alert('Message saved for user.');
};

// Delete user
window.delUser = async uid => {
  if (!confirm('Delete this user?')) return;
  await deleteDoc(doc(db, "users", uid));
  await deleteDoc(doc(db, "messages", uid));
  alert('User deleted.');
};

// Logout
document.getElementById('logout').addEventListener('click', async () => {
  try {
    await signOut(auth);
    alert('Logged out successfully!');
    location.href = 'index.html';
  } catch (err) {
    console.error('Logout error:', err);
    alert('Logout failed: ' + err.message);
  }
});

// Message all users
document.getElementById('msg-all-btn').addEventListener('click', async () => {
  const text = document.getElementById('msg-all').value;
  if (!text.trim()) return alert('Enter a message first.');
  const usersCol = collection(db, "users");
  const snapshot = await onSnapshot(usersCol, async snap => {
    snap.forEach(async u => {
      await setDoc(doc(db, "messages", u.id), { text });
    });
    alert('Message sent to all users.');
  });
});
</script>
</body>
</html>
