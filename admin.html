<!doctype html>
<html lang="en">
<head>
<meta charset="utf-8" />
<meta name="viewport" content="width=device-width,initial-scale=1" />
<title>Admin Dashboard</title>
<link rel="stylesheet" href="style.css">
<style>
body {
  background: linear-gradient(135deg, #111827, #0f766e);
}
table {
  width: 100%;
  border-collapse: collapse;
  margin-top: 20px;
}
td, th {
  border: 1px solid #334155;
  padding: 8px;
}
input {
  background: #1e293b;
  color: white;
  border: none;
  border-radius: 4px;
  padding: 4px;
}
button.small {
  background: #22d3ee;
  color: black;
  margin: 2px;
  padding: 6px 10px;
  border-radius: 6px;
  cursor: pointer;
}
</style>
</head>
<body>
<div class="container">
  <h2>Admin Dashboard</h2>
  <p id="admin-email"></p>

  <table id="user-table">
    <thead>
      <tr><th>Name</th><th>Email</th><th>Message</th><th>Action</th></tr>
    </thead>
    <tbody></tbody>
  </table>

  <button id="logout" class="small">Logout</button>
</div>

<script type="module">
import { auth, db, ADMIN_EMAIL, logout, sendMessage, deleteUser } from './main.js';
import { onAuthStateChanged } from "https://www.gstatic.com/firebasejs/11.0.0/firebase-auth.js";
import { collection, onSnapshot } from "https://www.gstatic.com/firebasejs/11.0.0/firebase-firestore.js";

const $ = id => document.getElementById(id);

// ðŸ”¹ Check admin status
onAuthStateChanged(auth, user => {
  if (!user || user.email !== ADMIN_EMAIL) {
    window.location.href = "index.html";
    return;
  }
  $('admin-email').innerText = `Logged in as ${user.email}`;
  loadUsers();
});

// ðŸ”¹ Live user updates
function loadUsers() {
  const tbody = document.querySelector('#user-table tbody');
  onSnapshot(collection(db, "users"), snapshot => {
    tbody.innerHTML = '';
    snapshot.forEach(u => {
      const data = u.data();
      const tr = document.createElement('tr');
      tr.innerHTML = `
        <td>${data.name}</td>
        <td>${data.email}</td>
        <td><input id="msg-${u.id}" placeholder="Enter message" style="width:90%"></td>
        <td>
          <button class="small" onclick="sendMsg('${u.id}')">Send</button>
          <button class="small" onclick="delUsr('${u.id}')">Delete</button>
        </td>`;
      tbody.appendChild(tr);
    });
  });
}

// ðŸ”¹ Send and delete functions
window.sendMsg = async uid => {
  const text = document.getElementById('msg-' + uid).value;
  if (!text.trim()) return alert("Enter a message first.");
  await sendMessage(uid, text);
  alert("Message saved for user.");
};

window.delUsr = async uid => {
  if (!confirm("Delete this user?")) return;
  await deleteUser(uid);
  alert("User deleted.");
};

// ðŸ”¹ Logout
$('logout').onclick = async () => {
  await logout();
  window.location.href = "index.html";
};
</script>
</body>
</html>
